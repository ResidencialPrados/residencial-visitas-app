<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Residencial Los Prados – Invitación</title>

  <!-- Estilos básicos (puedes moverlos luego a css/styles-visitor.css) -->
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      color: #004d40;
      text-align: center;
      margin: 0;
      padding: 20px;
    }
    header h1 {
      margin: 0;
      font-size: 1.8rem;
    }
    #welcome {
      margin: 10px 0 30px;
      font-size: 1.2rem;
    }
    #qr-section {
      display: none;
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      margin: 0 auto;
      max-width: 320px;
    }
    canvas#qr {
      display: block;
      margin: 0 auto 10px;
      border-radius: 8px;
    }
    p.note {
      margin-top: 20px;
      font-size: 0.95rem;
    }
  </style>

  <!-- QRious para generar el código QR -->
  <script src="https://cdn.jsdelivr.net/npm/qrious/dist/qrious.min.js"></script>
  <!-- Firebase App + Firestore compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <header>
    <h1>Residencial Los Prados</h1>
    <p id="welcome">Cargando invitación…</p>
  </header>

  <main>
    <section id="qr-section">
      <canvas id="qr" width="300" height="300"></canvas>
    </section>
    <p class="note">Por favor, muestra este código al Personal de Seguridad al ingresar.</p>
  </main>

  <script>
    // 1) Inicializa Firebase con tu configuración:
    firebase.initializeApp({
      apiKey: "AIzaSyAkKV3Vp0u9NGVRlWbx22XDvoMnVoFpItI",
      authDomain: "residencial-qr.firebaseapp.com",
      projectId: "residencial-qr",
      storageBucket: "residencial-qr.appspot.com",
      messagingSenderId: "21258599408",
      appId: "1:21258599408:web:81a0a5b062aac6e6bdfb35"
    });
    const db = firebase.firestore();

    // 2) Lee el parámetro ?id= de la URL
    const params  = new URLSearchParams(window.location.search);
    const visitId = params.get('id');
    const welcome = document.getElementById('welcome');
    const qrSec   = document.getElementById('qr-section');
    const qrEl    = document.getElementById('qr');

    if (!visitId) {
      welcome.textContent = "Error: falta el identificador de la visita.";
      throw new Error("visitor.html: parámetro id no proporcionado");
    }

    // 3) Consulta Firestore
    db.collection('visits').doc(visitId).get()
      .then(doc => {
        if (!doc.exists) {
          welcome.textContent = "Visita no encontrada.";
          return;
        }
        const data = doc.data();
        welcome.textContent = `Bienvenido, ${data.visitorName || 'Invitado'}`;

        // 4) Genera y muestra el QR
        new QRious({
          element: qrEl,
          value: visitId,
          size: 300
        });
        qrSec.style.display = 'block';
      })
      .catch(err => {
        console.error("Error cargando visita:", err);
        welcome.textContent = "Error cargando la visita.";
      });
  </script>
</body>
</html>
