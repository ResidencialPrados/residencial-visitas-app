<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard Guardia Administrador</title>

  <!-- Manifest PWA -->
  <link rel="manifest" href="../manifest.json" />

  <!-- Theme global -->
  <link rel="stylesheet" href="css/theme.css" />

  <!-- Estilos específicos de guard_admin -->
  <link rel="stylesheet" href="css/styles-guard-admin.css" />

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js" defer></script>

  <!-- QR Scanner -->
  <script src="https://unpkg.com/html5-qrcode" defer></script>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1 class="title">Dashboard Guardia Administrador</h1>
      <nav class="nav-buttons">
        <button id="logoutBtn" class="btn btn-primary">Cerrar sesión</button>
        <button id="activarQRBtn" class="btn btn-primary">Activar Lector QR</button>
        <button id="toggleHistorialBtn" class="btn btn-primary">Ver Historial Completo</button>
      </nav>
    </header>

    <main>
      <section id="qr-reader" class="qr-section" aria-hidden="true"></section>

      <section class="card">
        <h2>Visitas Pendientes (últimas 24 h)</h2>
        <table class="table">
          <thead>
            <tr>
              <th>Nombre Visitante</th>
              <th>Marca</th>
              <th>Color</th>
              <th>Placa</th>
              <th>Casa</th>
              <th>Bloque</th>
              <th>Teléfono</th>
              <th>Guardia</th>
              <th>Hora</th>
              <th>Acción</th>
            </tr>
          </thead>
          <tbody id="visitas-body">
            <tr><td colspan="10" class="loading">Cargando…</td></tr>
          </tbody>
        </table>
      </section>

      <section class="card">
        <h2>Registro de Usuario</h2>
        <form id="crearUsuarioForm" class="form-stack">
          <div class="field">
            <label for="rolUsuario">Rol:</label>
            <select id="rolUsuario" required>
              <option value="">Seleccione rol</option>
              <option value="guard">Guardia Común</option>
              <option value="guard_admin">Guardia Administrador</option>
              <option value="resident">Residente</option>
            </select>
          </div>

          <div id="camposExtra" class="form-stack hidden">
            <div class="field">
              <label for="nuevoEmail">Email:</label>
              <input type="email" id="nuevoEmail" placeholder="correo@ejemplo.com" required />
            </div>
            <div class="field">
              <label for="nuevoPassword">Contraseña:</label>
              <input type="password" id="nuevoPassword" minlength="6" placeholder="Mín. 6 caracteres" required />
            </div>
            <div class="field">
              <label for="nuevoConfirmPassword">Confirmar contraseña:</label>
              <input type="password" id="nuevoConfirmPassword" minlength="6" placeholder="Repite la contraseña" required />
            </div>
            <div class="field hidden" id="labelNombre">
              <label for="nuevoNombre">Nombre completo:</label>
              <input type="text" id="nuevoNombre" />
            </div>
            <div class="field hidden" id="labelIdentidad">
              <label for="nuevoIdentidad">Identidad:</label>
              <input type="text" id="nuevoIdentidad" />
            </div>
            <div class="field hidden" id="labelTelefono">
              <label for="nuevoTelefono">Teléfono:</label>
              <input type="text" id="nuevoTelefono" />
            </div>
            <div class="field hidden" id="labelCasa">
              <label for="nuevoCasa">Casa:</label>
              <input type="text" id="nuevoCasa" />
            </div>
            <div class="field hidden" id="labelBloque">
              <label for="nuevoBloque">Bloque:</label>
              <input type="text" id="nuevoBloque" />
            </div>
          </div>

          <button type="submit" class="btn btn-primary btn-block">Crear Usuario</button>
          <p id="crearUsuarioMsg" class="message"></p>
        </form>
      </section>

      <section class="card">
        <h2>Residentes y Pagos</h2>
        <div class="field">
          <input type="text" id="buscarResidente" placeholder="Buscar por nombre, correo, casa, bloque o teléfono" />
        </div>
        <table class="table">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Correo</th>
              <th>Teléfono</th>
              <th>Casa</th>
              <th>Bloque</th>
              <th>Estado de Pago</th>
              <th>Acción</th>
            </tr>
          </thead>
          <tbody id="residents-body">
            <tr><td colspan="7" class="loading">Cargando…</td></tr>
          </tbody>
        </table>
      </section>
    </main>

    <script>
      // Inicializar Firebase
      firebase.initializeApp({
        apiKey:    "AIzaSyAkKV3Vp0u9NGVRlWbx22XDvoMnVoFpItI",
        authDomain:"residencial-qr.firebaseapp.com",
        projectId: "residencial-qr",
        storageBucket:"residencial-qr.appspot.com",
        messagingSenderId:"21258599408",
        appId:     "1:21258599408:web:81a0a5b062aac6e6bdfb35"
      });

      const auth = firebase.auth();
      const db   = firebase.firestore();

      auth.onAuthStateChanged(async user => {
        if (!user) {
          window.location.href = "../index.html";
          return;
        }
        try {
          const doc = await db.collection('usuarios').doc(user.uid).get();
          const rol = doc.exists ? doc.data().rol : '';
          if (rol !== 'guard_admin') {
            alert("No tienes permiso para acceder al Dashboard de Guardia Administrador.");
            if (rol === 'guard') {
              window.location.href = "../guard/index.html";
            } else if (rol === 'resident') {
              window.location.href = "../resident/index.html";
            } else {
              window.location.href = "../index.html";
            }
          }
        } catch (err) {
          console.error("Error verificando rol:", err);
          window.location.href = "../index.html";
        }
      });
    </script>

    <script src="js/main-guard-admin.js" defer></script>

    <!-- Service Worker PWA -->
    <script>
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('../service-worker.js')
          .then(reg => console.log('✅ Service Worker registrado:', reg))
          .catch(err => console.error('❌ Error en Service Worker:', err));
      }
    </script>
  </div>
</body>
</html>
